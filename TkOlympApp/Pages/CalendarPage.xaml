<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:svc="clr-namespace:TkOlympApp.Services"
             xmlns:local="clr-namespace:TkOlympApp.Pages"
             xmlns:vm="clr-namespace:TkOlympApp.ViewModels"
             x:Class="TkOlympApp.Pages.CalendarPage"
             x:DataType="vm:CalendarViewModel"
             Title="{svc:Translate Calendar}">

    <ContentPage.ToolbarItems>
        <ToolbarItem IconImageSource="{AppThemeBinding Light=calendar_timeline.svg, Dark=calendar_timeline_white.svg}"
                     Order="Primary"
                     Priority="0"
                     Command="{Binding OpenCalendarViewCommand}" />
    </ContentPage.ToolbarItems>

    <ContentPage.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Resources/DataTemplates/CalendarDataTemplates.xaml" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid Padding="20,12,20,0">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Top row: My/All on the left, week navigation on the right -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" Padding="0" Margin="0,0,0,5">
            <HorizontalStackLayout Grid.Column="0" Padding="0" Spacing="8" VerticalOptions="Center">
                <Button Text="{svc:Translate Tab_My}"
                        Command="{Binding SwitchToMyEventsCommand}">
                    <Button.Triggers>
                        <DataTrigger TargetType="Button"
                                   Binding="{Binding MyTabActive}"
                                   Value="True">
                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=Black, Dark=LightGray}" />
                            <Setter Property="TextColor" Value="{AppThemeBinding Light=White, Dark=Black}" />
                        </DataTrigger>
                        <DataTrigger TargetType="Button"
                                   Binding="{Binding MyTabActive}"
                                   Value="False">
                            <Setter Property="BackgroundColor" Value="Transparent" />
                            <Setter Property="TextColor" Value="{AppThemeBinding Light=Black, Dark=White}" />
                        </DataTrigger>
                    </Button.Triggers>
                </Button>
                <Button Text="{svc:Translate Tab_All}"
                        Command="{Binding SwitchToAllEventsCommand}">
                    <Button.Triggers>
                        <DataTrigger TargetType="Button"
                                   Binding="{Binding AllTabActive}"
                                   Value="True">
                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=Black, Dark=LightGray}" />
                            <Setter Property="TextColor" Value="{AppThemeBinding Light=White, Dark=Black}" />
                        </DataTrigger>
                        <DataTrigger TargetType="Button"
                                   Binding="{Binding AllTabActive}"
                                   Value="False">
                            <Setter Property="BackgroundColor" Value="Transparent" />
                            <Setter Property="TextColor" Value="{AppThemeBinding Light=Black, Dark=White}" />
                        </DataTrigger>
                    </Button.Triggers>
                </Button>
            </HorizontalStackLayout>

            <HorizontalStackLayout Grid.Column="2" Padding="0" Spacing="8" VerticalOptions="Center" HorizontalOptions="End">
                <Button Text="◀"
                        Command="{Binding PreviousWeekCommand}"
                        Style="{StaticResource ButtonSecondary}" />
                <Button Text="{svc:Translate Today}"
                        Command="{Binding TodayCommand}" />
                <Button Text="▶"
                        Command="{Binding NextWeekCommand}"
                        Style="{StaticResource ButtonSecondary}" />
            </HorizontalStackLayout>
        </Grid>

        <RefreshView IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding RefreshCommand}"
                     Grid.Row="1">
            <Grid>
                <CollectionView ItemsSource="{Binding EventRows}"
                                ItemTemplate="{StaticResource CalendarTemplateSelector}"
                                SelectionMode="None">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical" ItemSpacing="0" />
                    </CollectionView.ItemsLayout>
                    
                    <!-- Tap handling for navigation -->
                    <CollectionView.Behaviors>
                        <local:CalendarItemTappedBehavior />
                    </CollectionView.Behaviors>
                </CollectionView>

                <Label Text="{Binding EmptyText}"
                       IsVisible="{Binding ShowEmpty}"
                       VerticalOptions="CenterAndExpand"
                       HorizontalOptions="Center" />
            </Grid>
        </RefreshView>
    </Grid>

</ContentPage>
